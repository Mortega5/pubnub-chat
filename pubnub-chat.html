<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../pubnub-element/pubnub-element.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/hardware-icons.html">
<link rel="import "href="../iron-icon/iron-icon.html">
<link rel="import "href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../firebase-element/firebase-collection.html">


<!--
An element providing a solution to no problem in particular.

Example:

<pubnub-chat></pubnub-chat>

Example:

<pubnub-chat>
<h2>Hello pubnub-chat</h2>
</pubnub-chat>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="pubnub-chat">
  <template>
    <style is="custom-style">
      :host {
      }
      .structure {
        width: 300px;
        border: 2px solid #797979;
        border-radius: 5px;
      }
      .header {
        background-color: var(--paper-green-400);
        color:#fefefe;
        height: 35px;
        padding: 2px 5px;
        border-bottom:2px solid var(--paper-green-800);
      }
      .header paper-icon-button {
        width: 35px;
        height: 35px;
        transition: all 0.3s ease-in;
      }
      .header paper-icon-button[rotate] {
        transform: rotate(180deg);
      }
      .header p{
        text-transform: capitalize;
      }
      .body {
        width: 100%;
        height: 350px;
        position:relative;
        overflow-x: hidden;
      }
      .bar {
        bottom: 0;top:0;
        position: absolute;
        z-index: 1000;
        width: 100%;
        height: 100%;
        /*-webkit-transition: fadeOut 0.3s ease-in;*/
        transition: left 0.3s ease-out;
        left: -100%;
        box-shadow: none;
        display:none;
      }

      .bar[show] {
        left:0;
        /*-webkit-transition: fadeIn 0.3s ease-out;*/
        transition: left 0.3s ease-out, background-color 0.7s ease-out;
        background-color: rgba(0,0,0,0.4);
      }
      .bar[show] div {
        box-shadow: 5px 5px 10px #454242;

      }
      .bar .avatar {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        border-color: var(--paper-pink-900);
        border: 2px solid;
      }
      .bar .userInfo{
        background-image:url('images/background.jpg');
        background-size: cover;
        background-repeat: no-repeat;
        text-align: center;
        width:80%;
        padding:10px 0px;
      }
      .bar .userInfo p {
        font-size: 18px;
        text-transform: capitalize;
        color: #fefefe;
      }
      .bar .menuContent {
        padding:10px 0px;
        position:relative;
        color: #333;
        background-color: var(--paper-grey-50);
        max-height: 100%;
        overflow-y: auto;
        width:80%;
      }
      .bar .menuContent p,
      .bar .menuContent span
      {
        margin: 10px;
        margin-left: 8px;
      }
      .bar .menuContent iron-icon[icon="assignment-ind"] {
        padding-left: 5px;
      }
      .bar .menuContent p {
        padding: 8px 8px 8px 30px;
        margin: 3px 0px;
      }
      .bar .menuContent p:hover {
        background-color: #eee;
        cursor: pointer;
      }
      .bar .menuContent .title {
        font-size: 16px;
      }
      .bar .menuContent .add {
        position:absolute;
        bottom:10px;
        right: 10px;
        --paper-fab-background: var(--paper-red-700);
      }
      .content {
        background-color: var(--paper-grey-300);
        width: 100%;
        height: 100%;
      }

      .msgs {
        overflow-y: auto;
        word-break: keep-all;
      }

      .msgs .message {
        margin: 5px 3%;
        border-radius: 10px;
        padding: 8px 40px 8px 15px;
      }
      .msgs .message.me .box {
        margin-left: auto;
      }
      .msgs .message .box,
      .msgs .message.me .box{
        background-color: #fefefe;
        padding: 5px 10px;
        border-radius: 5px;
      }
      .msgs .message .username {
        font-size: 16px;
        margin: 5px 0px;
        font-weight: bold;
        text-transform: capitalize;
      }
      .msgs .message .time {
        font-size: 12px;
        color: var(--paper-grey-700);
      }
      .msgs .message .avatar {
        min-width: 50px;
        min-height: 50px;
        margin: auto 5px;
        border-radius: 50%;
        margin-right: 10px;
        background-size: 100% 100%;
        background-repeat: no-repeat;
        border:2px solid #bbb;
      }
      .msgs .message .text {
        padding-left: 8px;
        word-break: break-all;

      }
      .center {
        margin:auto;
      }
      #textInput {
        margin: auto 8px;
        --paper-input-container-focus-color: var(--paper-green-800);
      }
      #textInput paper-icon-button {
        color: var(--paper-red-800);
      }
      .status {
        position: relative;
        top: 35px;
        left: 35px;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        background-color: #7EDF25;
        display: none;
      }
      .status.online {
        display: block;
      }
      .msgs hr {
        margin: auto 20px;
      }
      .inputs {
        border-top: 2px solid #797979;
        background-color: #fefefe;
      }
      .add{
        margin: auto 10px 10px auto;
        --paper-fab-background: var(--paper-green-400);
        width: 45px;
        height: 45px;
        --paper-fab-iron-icon: {
          width: 30px;
          height: 30px;
        }
      }
      .initial paper-input {
        padding: 2px 5px;
      }
      .format {
        padding: 12px 5px;
        font-size: 17px;
      }
      .format.textCenter {
        text-align: center;
      }
      .initial paper-button {
        background-color: var(--paper-green-400);
      }
      .format paper-button:hover {
        background-color: var(--paper-green-700);
      }
      .initial .chatOpened {
        border-bottom: 1px solid #999;
      }
      .initial .chatOpened:hover {
        background-color:#aaa;
      }
      .initial .chatOpened iron-icon {
        --iron-icon-height: 30px;
        --iron-icon-width: 30px;
        border-radius: 50%;
        margin:auto 3px;
      }
      .initial .chatOpened iron-icon /deep/ img {
        border-radius: 50%;
      }
      .content paper-fab[icon="add"] {
        position:absolute;
        bottom: 10px;
        right: 10px;
      }
      paper-fab[icon="send"] {
        width:28px;
        height:28px;
        --paper-fab-iron-icon: {
          width: 18px;
          height: 18px;
        }
      }
      #send {
        margin:auto 5px;;
      }
    </style>

    <firebase-collection
                         limit-to-first="3"
                         location="https://luminous-heat-7223.firebaseio.com/Chats"
                         data="{{dinosaurs}}"></firebase-collection>


    <!-- Use your own publish_key and subscribe_key please -->
    <iron-pubnub publish_key="{{publish_key}}" subscribe_key="{{subscribe_key}}" uuid="{{uuid}}" auth_key="{{auth_key}}" noleave auto>
      <iron-pubnub-subscribe auto channel="{{channel}}" id="sub" on-callback="subscribeCallback" on-presence="presenceChanged" on-error="error" timetoken="0">
        <iron-pubnub-publish channel="{{channel}}" message="" id="pub" on-error="error"></iron-pubnub-publish>
        <iron-pubnub-history id="his" channel="{{channel}}" count="30" on-success="historyRetrieved" on-error="error"></iron-pubnub-history>
      </iron-pubnub-subscribe>
      <iron-pubnub-where-now auto id="where" on-presence="whereIam"></iron-pubnub-where-now>
    </iron-pubnub>
    <div class="vertical layout structure">
      <!-- header -->
      <div class="header horizontal layout">
        <paper-icon-button rotate$="{{show_menu}}"on-tap="toggleBar" icon="{{menu_icon}}"></paper-icon-button>
        <p class="flex center">{{chat_title}}</p>
        <div class="center occupancyInfo" title="">
          <iron-icon icon="account-circle"></iron-icon>
          <span>{{occupancy}}</span>
        </div>
      </div>
      <div class="body" id="body" on-scroll="_moveBar">

        <!-- Message -->
        <div class="content vertical layout flex" hidden="{{_compareTo(chat_selected, -1, 1)}}">
          <div id="content" class="msgs flex">
            <template is="dom-repeat" items="{{messageList}}" observe="">
              <!-- Messages recived -->
              <template is="dom-if" if="{{_compareTo(index, 0, 0)}}">
                <hr>
              </template>
              <template class="test" is="dom-if" if="{{_compareTo(item.uuid, uuid, 0)}}">
                <div class="message horizontal layout">
                  <div class="avatar" style$="background-image: url({{item.avatar}})">
                    <div class$="status {{item.status}}"></div>
                  </div>
                  <div class="vertical layout box">
                    <div class="horizontal layout">
                      <span class="username flex">{{item.uuid}}</span>
                      <span class="time">{{item.time}}</span>
                    </div>
                    <span class="text">{{item.text}}</span>
                  </div>
                </div>
              </template>
              <!-- Messages sended -->
              <template is="dom-if" if="{{_compareTo(item.uuid, uuid, 1)}}">
                <div class="message horizontal layout me">
                  <div class=" box vertical layout">
                    <div class="horizontal layout">
                      <span class="username flex">me</span>
                      <span class="time">{{item.time}}</span>
                    </div>
                    <span class="text">{{item.text}}</span>
                  </div>
                </div>
              </template>
            </template>
          </div>
          <div class="horizontal layout inputs">
            <paper-input class="flex" id="textInput" label="Type message..." autofocus no-label-float on-keyup="_checkEnter" value="{{input_value}}">
            </paper-input>
            <div id="send"><paper-fab mini show="{{input_value}}" on-tap="publish" icon="send"></paper-fab></div>
          </div>
        </div>

        <!-- Left bar -->
        <div show$="{{show_menu}}" class="bar vertical layout" id="bar"s>
          <div class="userInfo">
            <img src="{{avatar}}" class="avatar">
            <p class="center">{{uuid}}</p>
          </div>
          <div class="menuContent flex">
            <iron-icon icon="assignment-ind"></iron-icon><span class="title">Chats Recientes</span>
            <template is="dom-repeat" items="{{myChats}}">
              <p class="user " on-click="openChat">{{item}}</p>
            </template>
            <hr>
            <p>Crear nuevo Chat</p>
            <paper-fab icon="add" mini class="add" on-tap="addNewChat"></paper-fab>
          </div>
        </div>

        <!-- Inicial chat -->
        <div class="content vertical layout initial" hidden="{{_compareTo(chat_selected, -1, 0)}}" style="position:absolute">
          <!-- Search bar -->
          <paper-input  class="searchBar" id="searchBar" label="Search chat..." no-label-float on-keyup="_checkEnter" value="{{search_value}}">
            <iron-icon icon="search" prefix></iron-icon>
          </paper-input>
          <!-- List of chat opened -->
          <div class="flex">
            <template is="dom-repeat" items="{{chats}}" filter="{{_searchContent(search_value)}}">
              <div class="chatOpened format" on-tap="selectChat" item$="{{index}}">
                <iron-icon src="{{item.icon}}"></iron-icon>
                {{item.name}}
              </div>
            </template>
            <template is="dom-if" if="{{_compareTo(chats,0, 1)}}">
              <div class="format textCenter">
                <p>There are not chats yet. But you don't worry. You can create one.</p>
                <paper-button on-tap="createChat">Create Chat</paper-button>
              </div>
            </template>
          </div>
        </div>
      </div>

    </div>

  </template>

  <script>
    Polymer({
      is: 'pubnub-chat',

      properties: {
        publish_key: {
          type: String,
          reflectToAttribute: true
        },
        subscribe_key :{
          type: String,
          reflectToAttribute: true
        },
        uuid: {
          type: String,
          reflectToAttribute: true,
          value: ""
        },
        pastMsgs: {
          type: Array,
          value: function(){return []}
        },
        avatar: {
          type: String,
          reflectToAttribute: true
        },
        onlineUuids: {
          type: Array,
          value: function(){return []}
        },
        messageList: {
          type: Array,
          value: function(){return []}
        },
        channel: {
          type: String,
          reflectToAttribute: true,
          observer: 'getChatName'
        },
        show_menu: {
          type: Boolean,
          value: false,
          reflectToAttribute:true
        },
        avatar: {
          type: String,
          value: 'https://pbs.twimg.com/profile_images/457552884436336640/NIiM7w-w.jpeg',
          reflectToAttribute:true
        },
        auth_key: {
          type: String,
          value: "juanfran",
          reflectToAttribute: true
        },
        chat_title: {
          type: String
        },
        menu_icon: {
          type: String,
          value: "menu"
        },
        chats: {
          type: Array,
          value: function(){return []}
        },
        chat_selected: {
          type: Number,
          value: -1
        }
      },
      observers: ['getChatName(onlineUuids.length)'],
      // Element Lifecycle

      ready: function() {
        var el = this.querySelector(".preload");
        this.toggleClass('preload',false,el);
        var back = this;
        setInterval(function(){
          back._changeTime();
        },30000);
      },
      toggleBar: function(){
        this.show_menu = !this.show_menu;
        this.menu_icon = this.menu_icon == "menu" ? "arrow-forward": "menu";
        this.$.where.whereNow();
      },
      _scrollToBottom: function(oldvalue, newvalue){
        this.$.content.scrollTop = this.$.content.scrollHeight;
      },
      subscribeCallback: function(event){
        if(this.$.sub.messages.length > 0) {
          var isBottom = this.$.content.scrollHeight - this.$.content.scrollTop == this.$.content.clientHeight;
          this.displayChatList(this.pastMsgs.concat(this.getListWithOnlineStatus(this.$.sub.messages)), isBottom);
        }
      },
      presenceChanged: function(){
        // Comprobar que los mensajes vienen del chat registrado
        var l = this.$.sub.presence.length;
        var d = this.$.sub.presence[l - 1];

        // how many users
        this.occupancy = d.occupancy;

        // who are online
        if(d.action === 'join') {
          this.push("onlineUuids", d.uuid);
        } else {
          var idx = this.onlineUuids.indexOf(d.uuid);
          if(idx > -1) {
            this.splice("onlineUuids",idx, 1);
          }
        }
        if(this.messageList.length > 0) {
          this.set('messageList', this.getListWithOnlineStatus(this.messageList));
          this._changeTime();
        }
      },
      error: function(e){
        console.error(e);

      },
      historyRetrieved: function(e){
        if(e.detail[0].length > 0) {
          this.pastMsgs = this.getListWithOnlineStatus(e.detail[0]);
          this.displayChatList(this.pastMsgs, true);
        } else {
          this.set('pastMsgs',[]);
          this.set('messageList',[]);
        }
      },
      displayChatList: function(list, isBottom){
        this.messageList = list;
        this._changeTime();
        this.async(function(){
          if (isBottom)
            this._scrollToBottom();
        }, 5);
      },
      publish: function() {
        if(!this.$.textInput.value) return;

        this.$.pub.message = {
          uuid: this.uuid,
          avatar: this.avatar,
          color: "red",
          text: this.$.textInput.value,
          timestamp: new Date().toISOString()
        };

        this.$.pub.publish();
        this.$.textInput.value = '';
      },

      getListWithOnlineStatus: function(list) {
        var back = this;
        [].forEach.call(list, function(l) {
          // sanitize avatars
          var name = l.uuid;
          /// El avatar tiene que cogerse de una peticion, ver como coger
          // Se debe coger del servidor
          l.avatar = l.avatar;
          // Default avatar
          if(back.onlineUuids && back.onlineUuids.indexOf(l.uuid) > -1) {
            l.status = 'online';
          } else {
            l.status = 'offline';
          }
        });
        return list;
      },
      _changeTime: function(){
        for (i=0;i<this.messageList.length;i++){
          var date = new Date(this.messageList[i].timestamp);
          var current_date = new Date();
          var time;

          var ms = current_date - date;
          var sec = Math.round(ms / 1000);
          var min = Math.round(sec / 60);
          var hr = Math.round(min / 60);
          var day = Math.round(hr / 24);
          var month = Math.round(day / 24);
          var year = Math.round(month / 12);
          if (ms < 0) {
            time = 'just now';
          } else if (sec < 10) {
            time = 'just now';
          } else if (sec < 45) {
            time = sec + ' seconds ago';
          } else if (sec < 90) {
            time = 'a minute ago';
          } else if (min < 60) {
            time = min + ' minutes ago';
          } else if (day < 1) {
            time = "Today - " + date.getHours()+":";
            time += date.getMinutes() < 10? "0" + date.getMinutes(): date.getMinutes();
          } else {
            var month = ["Jan","Feb","Mar","Apr", "May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            time = date.getDate()+" "+month[date.getMonth()] + ". "+date.getFullYear() + " - " + date.getHours()+":";
            time += date.getMinutes() < 10? "0" + date.getMinutes(): date.getMinutes();
          }
          if (typeof this.messageList[i] === "Object"){
            this.set('messageList.'+i+'.time', time);
          }
        }
      },
      _checkEnter: function(e){
        if(e.keyCode === 13 || e.charCode === 13) {
          this.publish();
        }
      },
      getChatName: function(){
        /*        if (size === 2) {
          var idx = size - 1 - this.onlineUuids.indexOf(this.uuid);
          this.chat_title = this.onlineUuids[idx];
        } else */if (this.chat_selected){
          this.chat_title = this.channel;
        } else {
          this.chat_title = "Polymer Chat";
        }

      },
      _compareTo: function(value1, value2, value) {
        var result = value1==value2?1:0;
        return result==value;
      },
      whereIam: function(e){
        this.myChats = e.detail.channels;
      },
      _searchContent: function(string) {
        if (!string) {
          // set filter to null to disable filtering
          return null;
        } else {
          // return a filter function for the current search string
          string = string.toLowerCase();
          return function(item) {
            return item.name.indexOf(string) > -1;
          };
        }
      },
      selectChat: function(event) {
        var index = event.currentTarget.getAttribute('item');
        var item = this.chats[index];
        console.info("Seleccionado: ", item.name);
        this.channel = item.channel;
        this.chat_selected = index;
        this.$.where.whereNow();
      },
      openChat: function(event){
        var name = event.currentTarget.textContent;
        this.channel = name;
        this.chat_selected = name;
        this.toggleBar();
        this.$.where.whereNow();
      },
      addNewChat: function(){
        this.chat_selected = -1;
        this.toggleBar();
      },
      createChat: function(){
        console.log("TODO crear chat");
      },
      _moveBar: function(e){
        this.$.bar.style.top = e.target.scrollTop + "px";
        
      }
    });
  </script>
</dom-module>

