<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../pubnub-element/pubnub-element.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import "href="../iron-icon/iron-icon.html">
<link rel="import "href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">


<!--
An element providing a solution to no problem in particular.

Example:

<pubnub-chat></pubnub-chat>

Example:

<pubnub-chat>
<h2>Hello pubnub-chat</h2>
</pubnub-chat>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="pubnub-chat">
  <template>
    <style is="custom-style">
      .structure {
        width: 500px;
        border: 2px solid #797979;
        border-radius: 5px;
      }
      .header {
        background-color: var(--paper-green-400);
        color:white;
        padding: 10px;
        border-bottom:2px solid var(--paper-green-800);
      }
      .header p{
        text-transform: uppercase;
      }
      .body {
        width: 100%;
        height: 450px;
        position:relative;
      }
      .bar {
        bottom: 0;top:0;
        border-right: 2px solid;
        border-right-color: var(--paper-grey-600);
        opacity: 1;
        width: 150px;
        position: absolute;
        z-index: 1000;
      }
      .bar[hide] {
        width: 0 !important;
        opacity: 0;
      }
      .bar .avatar {
        border-radius: 50%;
        width: 60px;
        height: 60px;
        margin-top:25px;
        border-color: var(--paper-pink-900);
        border: 2px solid;
      }
      .bar .userInfo{
        padding: 10px;
        min-height: 100px;
        background-image:url('images/background.jpg');
        background-size: cover;
        background-repeat: no-repeat;

      }
      .bar .userInfo p {
        font-size: 18px;
        text-transform: capitalize;
        color: white;
      }
      .bar .userList {
        padding:5px;
        color: grey;
        background-color: var(--paper-grey-50);
        max-height: 100%;
        overflow-y: auto;
      }
      .bar .userList .user {
        margin:10px;
      }
      .content {
        background-color: var(--paper-grey-300);
        width: 100%;
        height: 100%;
      }

      .msgs {
        overflow-y: auto;
        word-break: keep-all;
      }

      .msgs .message {
        margin: auto;
        margin: 5px 15px;
        border-radius: 10px;
        padding: 8px 40px 8px 15px;
      }
      .msgs .message.me .box{
        margin-left:auto;
      }
      .msgs .message .box,
      .msgs .message.me .box{
        background-color: white;
        padding: 5px 10px;
        border-radius: 5px;
      }
      .msgs .message .username {
        font-size: 16px;
        margin: 5px 0px;
        font-weight: bold;
        text-transform: capitalize;
      }
      .msgs .message .time {
        font-size: 12px;
        color: var(--paper-grey-700);
      }
      .msgs .message .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
        background-size: 100% 100%;
        background-repeat: no-repeat;
        border:2px solid #bbb;
      }
      .msgs .message .text {
        padding-left: 8px;
      }
      .center {
        margin:auto;
      }
      #textInput {
        margin: auto 8px;
        --paper-input-container-focus-color: var(--paper-red-800);
      }
      #textInput paper-icon-button {
        color: var(--paper-red-800);
      }
      .status {
        position: relative;
        top: 35px;
        left: 35px;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        background-color: #7EDF25;
        display: none;
      }
      .status.online {
        display: block;
      }
      hr {
        margin:auto 20px;
      }
    </style>

    <!-- Use your own publish_key and subscribe_key please -->
    <core-pubnub publish_key="{{publish_key}}" subscribe_key="{{subscribe_key}}" uuid="{{uuid}}" auth_key="{{auth_key}}" noleave>
      <core-pubnub-subscribe channel="{{channel}}" id="sub" on-callback="subscribeCallback" on-presence="presenceChanged" on-error="error" timetoken="0">
        <core-pubnub-publish channel="{{channel}}" message="" id="pub" on-error="error"></core-pubnub-publish>
        <core-pubnub-history channel="{{channel}}" count="30" on-success="historyRetrieved" on-error="error"></core-pubnub-history>
      </core-pubnub-subscribe>
    </core-pubnub>
    <div class="vertical layout structure">
      <div class="header horizontal layout">
        <paper-icon-button on-tap="toogleBar" icon="menu"></paper-icon-button>
        <p class="flex center">{{chat_title}}</p>
        <div class="center">
          <iron-icon icon="account-circle"></iron-icon>
          <span>{{occupancy}}</span>
        </div>
      </div>

      <div class$="body {{menu_hidden}}">
        <div hide$="{{menu_hidden}}" class="bar vertical layout">
          <paper-material elevation=1>
            <div class="userInfo">
              <img src="{{avatar}}" class="avatar">
              <p class="center">{{uuid}}</p>
            </div>
          </paper-material>
          <div class="userList flex">
            <p>ONLINE NOW</p>
            <template is="dom-repeat" items="{{onlineUuids}}">
              <p class="user">{{item}}</p>
            </template>
          </div>
        </div>
        <div class="content vertical layout flex">
          <div id="content" class="msgs flex">
            <template is="dom-repeat" items="{{messageList}}" observe="">
              <template is="dom-if" if="{{_compareTo(item.uuid, uuid, 0)}}">
                <div class="message horizontal layout">
                  <div class="avatar" style$="background-image: url({{item.avatar}})">
                    <div class$="status {{item.status}}"></div>
                  </div>
                  <div class="vertical layout box">
                    <div class="horizontal layout">
                      <span class="username flex">{{item.uuid}}</span>
                      <span class="time">{{item.time}}</span>
                    </div>
                    <span class="text">{{item.text}}</span>
                  </div>
                </div>
                <hr>
              </template>
              <template is="dom-if" if="{{_compareTo(item.uuid, uuid, 1)}}">
                <div class="message horizontal layout me">
                  <div class=" box vertical layout">
                    <div class="horizontal layout">
                      <span class="username flex">me</span>
                      <span class="time">{{item.time}}</span>
                    </div>
                    <span class="text">{{item.text}}</span>
                  </div>
                </div>
                <hr>
              </template>
            </template>

          </div>
          <paper-input id="textInput" label="Type message..." autofocus no-label-float on-keyup="_checkEnter">
            <paper-icon-button suffix icon="send" on-tap="publish"></paper-icon-button>
          </paper-input>
        </div>
      </div>
    </div>

  </template>

  <script>
    Polymer({
      is: 'pubnub-chat',

      properties: {
        publish_key: {
          type: String,
          reflectToAttribute: true
        },
        subscribe_key :{
          type: String,
          reflectToAttribute: true
        },
        uuid: {
          type: String,
          reflectToAttribute: true
        },
        pastMsgs: {
          type: Array,
          value: function(){return []}
        },
        avatar: {
          type: String,
          reflectToAttribute: true
        },
        onlineUuids: {
          type: Array,
          value: function(){return []}
        },
        messageList: {
          type: Array,
          value: function(){return []}
        },
        channel: {
          type: String,
          value: "polymer-chat"
        },
        menu_hidden: {
          type: Boolean,
          value: false,
          reflectToAttribute:true

        },
        avatar: {
          type: String,
          value: 'https://pbs.twimg.com/profile_images/457552884436336640/NIiM7w-w.jpeg',
          reflectToAttribute:true
        },
        auth_key: {
          type: String,
          value: "juanfran",
          reflectToAttribute: true
        },
        chat_title: {
          type: String
        }
      },
      observers: ['_takeName(onlineUuids.length)'],
      // Element Lifecycle

      ready: function() {
        var back = this;
        setInterval(function(){
          back._changeTime();
        },30000);
      },
      toogleBar: function(){
        this.menu_hidden = !this.menu_hidden;
      },
      _scrollToBottom: function(oldvalue, newvalue){
        this.$.content.scrollTop = this.$.content.scrollHeight;
      },
      subscribeCallback: function(event){
        if(this.$.sub.messages.length > 0) {
          var isBottom = this.$.content.scrollHeight - this.$.content.scrollTop == this.$.content.clientHeight;
          this.displayChatList(this.pastMsgs.concat(this.getListWithOnlineStatus(this.$.sub.messages)), isBottom);
        }
      },
      presenceChanged: function(){
        var l = this.$.sub.presence.length;
        var d = this.$.sub.presence[l - 1];

        // how many users
        this.occupancy = d.occupancy;

        // who are online
        if(d.action === 'join') {
          this.push("onlineUuids", d.uuid);
        } else {
          var idx = this.onlineUuids.indexOf(d.uuid);
          if(idx > -1) {
            this.splice("onlineUuids",idx, 1);
          }
        }
        if(this.messageList.length > 0) {
          this.set('messageList', this.getListWithOnlineStatus(this.messageList));
          this._changeTime();
        }
      },
      error: function(e){
        console.error(e);

      },
      historyRetrieved: function(e){
        if(e.detail[0].length > 0) {
          this.pastMsgs = this.getListWithOnlineStatus(e.detail[0]);
          this.displayChatList(this.pastMsgs, true);
        }
      },
      displayChatList: function(list, isBottom){
        this.messageList = list;
        this._changeTime();
        this.async(function(){
          if (isBottom)
            this._scrollToBottom();
        }, 5);
      },
      publish: function() {
        if(!this.$.textInput.value) return;

        this.$.pub.message = {
          uuid: this.uuid,
          avatar: this.avatar,
          color: "red",
          text: this.$.textInput.value,
          timestamp: new Date().toISOString()
        };

        this.$.pub.publish();
        this.$.textInput.value = '';
      },

      getListWithOnlineStatus: function(list) {
        var back = this;
        [].forEach.call(list, function(l) {
          // sanitize avatars
          var name = l.uuid;
          /// El avatar tiene que cogerse de una peticion, ver como coger
          // Se debe coger del servidor
          l.avatar = l.avatar;
          // Default avatar
          if(back.onlineUuids && back.onlineUuids.indexOf(l.uuid) > -1) {
            l.status = 'online';
          } else {
            l.status = 'offline';
          }
        });
        return list;
      },
      _changeTime: function(){
        for (i=0;i<this.messageList.length;i++){
          var date = new Date(this.messageList[i].timestamp);
          var current_date = new Date();
          var time;

          var ms = current_date - date;
          var sec = Math.round(ms / 1000);
          var min = Math.round(sec / 60);
          var hr = Math.round(min / 60);
          var day = Math.round(hr / 24);
          var month = Math.round(day / 24);
          var year = Math.round(month / 12);
          if (ms < 0) {
            time = 'just now';
          } else if (sec < 10) {
            time = 'just now';
          } else if (sec < 45) {
            time = sec + ' seconds ago';
          } else if (sec < 90) {
            time = 'a minute ago';
          } else if (min < 60) {
            time = min + ' minutes ago';
          } else if (day < 1) {
            time = "Today - " + date.getHours()+":";
            time += date.getMinutes() < 10? "0" + date.getMinutes(): date.getMinutes();
          } else {
            var month = ["Jan","Feb","Mar","Apr", "May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            time = date.getDate()+" "+month[date.getMonth()] + ". "+date.getFullYear() + " - " + date.getHours()+":";
            time += date.getMinutes() < 10? "0" + date.getMinutes(): date.getMinutes();
          }
          if (typeof this.messageList[i] === "Object"){
            this.set('messageList.'+i+'.time', time);
          }
        }
      },
      _checkEnter: function(e){
        if(e.keyCode === 13 || e.charCode === 13) {
          this.publish();
        }
      },
      _takeName: function(size){
        if (size === 2) {
          var idx = size - 1 - this.onlineUuids.indexOf(this.uuid);
          this.chat_title = this.onlineUuids[idx];
        } else {
          this.chat_title = "Diff 2";
        }
      },
      _compareTo: function(value1, value2, value) {
        var result = value1==value2?1:0;
        return result==value;
      }

    });
  </script>
</dom-module>
